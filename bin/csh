#!/bin/bash

source /usr/bitey/software/coffee/pak.conf
VERSION="$PACKAGE_VERSION"
coffee_shell() {
  local COFFEE="$HOME/.coffee"
  local CONF="$COFFEE/config/csh.conf"
  local HISTFILE="$COFFEE/history"

  # Ensure shell directory exists
  if [[ ! -d "$COFFEE" ]]; then
    mkdir -p "$COFFEE"
  fi

  if [[ ! -d "$COFFEE/presets" ]]; then
      mkdir "$COFFEE/presets"
      coffee preset --copy
      coffee preset cappuccino
  fi

  # Load rest of the shell
  if [[ ! -f "$COFFEE/done" ]]; then
      echo -e "☕️ Welcome to Coffee Shell!\n❔ Run \"help\" to get started."
      touch "$COFFEE/done"
  fi
  if [[ ! -f "$HISTFILE" ]]; then
      touch "$HISTFILE"
  fi
  for plugin in "$COFFEE/plugins/"*.sh; do
      [[ -f "$plugin" ]] && source "$plugin"
  done
  [[ -f "$COFFEE/config/aliases.conf" ]] && source "$COFFEE/config/aliases.conf"
  

  history -r "$HISTFILE"

  while true; do
    [[ -f "$CONF" ]] && source "$CONF" # Load config
    local PROMPT="${CSH_PROMPT:-☕️ $(whoami) $(pwd)>}"
    local ERROR="${CSH_ERROR:-❌}"
    [[ -z "$cmd" ]] && echo -e "$PROMPT " && read -e -r cmd
    [[ -z "$cmd" ]] && continue

    echo "$cmd" >> "$HISTFILE"
    history -s "$cmd"

    case "$cmd" in
      exit)
        break
        ;;
      help)
        coffee --help
        ;;
      version)
        coffee --version
        ;;
      restart)
        echo "♻  Restarting Coffee Shell..."
        exec /usr/bin/csh
        exit 0
        ;;
      *)
        if command -v "${cmd%% *}" >/dev/null 2>&1; then
            eval "$cmd" 2> >(sed "s|^.*: line [0-9]*: |$ERROR |" >&2)
        else
            echo "$ERROR Unknown command: $cmd"
        fi
        ;;

    esac
    cmd=""
  done
}

# Coffee Shell Script Mode
if [[ -f "$1" ]]; then
    SCRIPT="$1"
    if [[ ! -f "$SCRIPT" ]]; then
        echo "❌ $SCRIPT: No such file or directory."
    fi
    while IFS= read -r line || [[ -n "$line" ]]; do
        cmd="$line"
        source /usr/bin/coffee_shell || exit 1
    done < "$SCRIPT"
    exit 0
fi

coffee_shell
exit 0
