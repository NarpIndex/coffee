#!/bin/bash

source /usr/bitey/software/coffee/pak.conf
VERSION="$PACKAGE_VERSION"
cf_input() {
    REPLY=$(reader "$1" -e "$HISTFILE")
}
coffee_shell() {
  local COFFEE="$HOME/.coffee"
  local CONF="$COFFEE/config/csh.conf"
  local HISTFILE="$COFFEE/history"

  [[ -f "$COFFEE/profile" ]] && source "$COFFEE/profile"

  if [[ ! -d "$COFFEE" ]]; then
    mkdir -p "$COFFEE"
    cat << 'EOF' > "$COFFEE/rc"
#!/bin/bash
# Coffee RC
EOF
    chmod +x "$COFFEE/rc"
  fi

  if [[ ! -f "$COFFEE/profile" ]]; then
    cat << 'EOF' > "$COFFEE/profile"
# ~/.coffee/profile
# Run commands when Coffee Shell starts

export PATH="$HOME/.coffee/bin:$PATH"
export PATH="$HOME/.local/bin:$PATH"
EOF
    source "$COFFEE/profile"
  fi

  source "$COFFEE/rc"

  if [[ ! -d "$COFFEE/presets" ]]; then
    mkdir "$COFFEE/presets"
    coffee preset --copy
    coffee preset cappuccino
  fi

  if [[ ! -f "$COFFEE/done" ]]; then
    echo -e "☕️ Welcome to Coffee Shell!\n❔ Run \"help\" to get started."
    touch "$COFFEE/done"
  fi

  [[ -f "$HISTFILE" ]] || touch "$HISTFILE"

  for plugin in "$COFFEE/plugins/"*.sh; do
    [[ -f "$plugin" ]] && source "$plugin"
  done

  [[ -f "$COFFEE/config/aliases.conf" ]] && source "$COFFEE/config/aliases.conf"

  history -r "$HISTFILE"

  YELLOW='\033[1;33m'
  NC='\033[0m' # No color
  
  local temp_loop
  temp_loop=$(mktemp)

  # Load enabled patches
  PATCHDIR="$COFFEE/patches"
  find "$PATCHDIR" -type f -name '*.sh' ! -path '*/disabled/*' | while read -r patch; do
    patch_dir=$(dirname "$patch")
    if [[ -f "$patch_dir/looped.txt" ]]; then
        echo "source $patch" >> "$temp_loop"
    fi
    source "$patch"
  done
  
  local cmd=""
  while true; do
    [[ -f "$CONF" ]] && source "$CONF" # Load config
    local PROMPT="${CSH_PROMPT:-☕️ $(whoami) $(pwd)>}"
    local ERROR="${CSH_ERROR:-❌}"
    should_continue=false

    cf_input "$PROMPT "
    cmd=$REPLY

    [[ -z "$cmd" ]] && continue

    # Replace !! with last command from history
    if [[ "$cmd" == *"!!"* ]]; then
      sed -i '$d' "$HISTFILE"
      last_cmd=$(tail -n 1 "$HISTFILE")
      cmd="${cmd//!!/$last_cmd}"
      echo "$cmd" >> "$HISTFILE"
      history -s "$cmd"
    fi

    export cmd
    source "$temp_loop"
    if $should_continue; then
        continue
    fi

    case "$cmd" in
      exit)
        history -a "$HISTFILE"
        break
        ;;
      help)
        coffee --help
        ;;
      version)
        coffee --version
        ;;
      restart)
        echo "♻  Restarting Coffee Shell..."
        exec /bin/bash "$0"
        ;;
      *)
        if command -v "${cmd%% *}" >/dev/null 2>&1; then
          eval "$cmd" 2> >(sed "s|^.*: line [0-9]*: |$ERROR |" >&2)
        else
          echo "$ERROR Unknown command: $cmd"
        fi
        ;;
    esac
    cmd=""
  done
}


# Coffee Shell Script Mode
if [[ -f "$1" ]]; then
    SCRIPT="$1"
    if [[ ! -f "$SCRIPT" ]]; then
        echo "❌ $SCRIPT: No such file or directory."
    fi
    while IFS= read -r line || [[ -n "$line" ]]; do
        cmd="$line"
        source /usr/bin/coffee_shell || exit 1
    done < "$SCRIPT"
    exit 0
fi

coffee_shell
exit 0
