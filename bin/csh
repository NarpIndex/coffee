#!/bin/bash

coffee_shell() {
  local COFFEE="$HOME/.coffee"
  local CONF="$COFFEE/config/csh.conf"
  local HISTFILE="$COFFEE/history"

  # Load prompt from config
  if [[ -f "$CONF" ]]; then
    source "$CONF"
  fi

  if [[ ! -f "$COFFEE/done" ]]; then
      echo -e "☕️ Welcome to Coffee Shell!\nType 'help' to get started."
      touch "$COFFEE/done"
  fi

  if [[ ! -d "$HOME/.coffee" ]]; then
      mkdir -p "$HOME/.coffee"
  fi
  if [[ ! -f "$HISTFILE" ]]; then
      touch "$HISTFILE"
  fi
  history -r "$HISTFILE"

  while true; do
    local PROMPT="${CSH_PROMPT:-☕️ $(whoami) $(pwd)> }"
    read -e -rp "$PROMPT " cmd
    [[ -z "$cmd" ]] && continue

    echo "$cmd" >> "$HISTFILE"
    history -s "$cmd"

    case "$cmd" in
      exit)
        echo "☕️ Goodbye!"
        break
        ;;
      reload)
        echo "♻️ Reloading Coffee Shell Config..."
        coffee_shell
        return 0
        ;;
      help)
        coffee --help
        ;;
      version)
        coffee --version
        ;;
      *)
        if command -v "${cmd%% *}" >/dev/null 2>&1; then
            $cmd
        else
            echo "❌ Unknown command: $cmd"
        fi
        ;;

    esac
  done
}

coffee_shell
exit 0
