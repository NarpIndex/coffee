#!/bin/bash

source /usr/bitey/software/coffee/pak.conf
VERSION="$PACKAGE_VERSION"
COFFEE_DIR="$HOME/.coffee"
CONF_FILE="$COFFEE_DIR/config/csh.conf"

if [[ ! -d "$COFFEE_DIR/config" ]]; then
    mkdir -p "$COFFEE_DIR/config"
fi

if [[ "$1" == "set" && -n "$2" && -n "$3" ]]; then
    VAR_NAME="$2"
    VAR_VALUE="$3"

    # Create config file if it doesn't exist
    if [[ ! -f "$CONF_FILE" ]]; then
        touch "$CONF_FILE"
        echo -e "#!/bin/bash\n" > "$CONF_FILE"
    fi

    # Remove existing line with the variable (if it exists)
    sed -i "/^\s*${VAR_NAME}=.*/d" "$CONF_FILE"

    # Append new variable setting
    echo "${VAR_NAME}=\"${VAR_VALUE}\"" >> "$CONF_FILE"
    echo "‚úÖ Set $VAR_NAME to \"$VAR_VALUE\" in $CONF_FILE"
    exit 0
fi

if [[ $# -eq 0 ]]; then
    echo "‚ùî Run \"help\" (in shell) or \"coffee --help\" for usage."
    exit 0
fi

if [[ "$1" == "--help" ]]; then
    echo "üí° Coffee Help"
    echo
    echo "üêö Shell:"
    echo "    exit - Exit the Shell."
    echo "    help - See the help message."
    echo "    version - See the version."
    echo "    restart - Restart the Shell."
    echo "üéà CLI:"
    echo "    coffee set <VAR_NAME> <VALUE> - Set a shell configuration variable."
    echo "    coffee default - Reset your configuration."
    echo "    coffee preset <PRESET_NAME> - Load a preset."
    echo "    coffee --help - See the help message."
    echo "    coffee --version - See the version."
    echo "üíª Other:"
    echo "    csh - Run a Coffee Shell session."
    echo "    chsh -s /usr/bin/csh - Change your shell to Coffee Shell."
    echo
fi

if [[ "$1" == "--version" ]]; then
    echo "‚òï Coffee $VERSION"
    exit 0
fi

if [[ "$1" == "default" ]]; then
    rm -rf "$HOME/.coffee/config"
    echo "‚úÖ Configuration reset. Please restart Coffee Shell to apply changes."
    exit 0
fi

if [[ "$1" == "preset" && "$2" == "--list" ]]; then
    echo "üì¶ Available presets:"
    for dir in "$COFFEE_DIR/presets/"*/ ; do
        basename "$dir"
    done
    exit 0
fi

if [[ "$1" == "preset" ]]; then
    PRESET="$2"
    PRESET_DIR="$COFFEE_DIR/presets/$PRESET"
    if [[ ! -d "$PRESET_DIR" ]]; then # Prevent accedental config deletion and copying non-existent presets.
        echo "‚ùå Preset $PRESET can't be found."
        exit 1
    fi
    rm -rf "$COFFEE_DIR/config"
    mkdir "$COFFEE_DIR/config"
    cp $PRESET_DIR/* "$COFFEE_DIR/config"
    echo "‚úÖ Loaded preset $PRESET."
    exit 0
fi
