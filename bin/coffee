#!/bin/bash

source /usr/bitey/software/coffee/pak.conf
VERSION="$PACKAGE_VERSION"
COFFEE_DIR="$HOME/.coffee"
CONF_FILE="$COFFEE_DIR/config/csh.conf"

if [[ ! -d "$COFFEE_DIR/config" ]]; then
    mkdir -p "$COFFEE_DIR/config"
fi

if [[ "$1" == "set" && -n "$2" && -n "$3" ]]; then
    VAR_NAME="$2"
    VAR_VALUE="$3"

    # Create config file if it doesn't exist
    if [[ ! -f "$CONF_FILE" ]]; then
        touch "$CONF_FILE"
        echo -e "#!/bin/bash\n" > "$CONF_FILE"
    fi

    # Remove existing line with the variable (if it exists)
    sed -i "/^\s*${VAR_NAME}=.*/d" "$CONF_FILE"

    # Append new variable setting
    echo "${VAR_NAME}=\"${VAR_VALUE}\"" >> "$CONF_FILE"
    echo "‚úÖ Set $VAR_NAME to \"$VAR_VALUE\" in $CONF_FILE"
    exit 0
fi

if [[ $# -eq 0 ]]; then
    echo "‚ùî Run \"help\" (in shell) or \"coffee --help\" for usage."
    exit 0
fi

if [[ "$1" == "--help" ]]; then
    echo "üí° Coffee Help"
    echo
    echo "üêö Shell:"
    echo "    exit - Exit the Shell."
    echo "    help - See the help message."
    echo "    version - See the version."
    echo "    restart - Restart the Shell."
    echo "üéà CLI:"
    echo "    coffee set <VAR_NAME> <VALUE> - Set a shell configuration variable."
    echo "    coffee default - Reset your configuration."
    echo "    coffee preset <PRESET_NAME> - Load a preset."
    echo "    coffee preset --copy - Create presets directory and copy default presets."
    echo "    coffee preset --list - See all presets."
    echo "    coffee --help - See the help message."
    echo "    coffee --version - See the version."
    echo "üíª Other:"
    echo "    csh - Run a Coffee Shell session."
    echo "    chsh -s /usr/bin/csh - Change your shell to Coffee Shell."
    echo
fi

if [[ "$1" == "--version" ]]; then
    echo "‚òï Coffee $VERSION"
    exit 0
fi

if [[ "$1" == "default" ]]; then
    coffee preset cappuccino
    echo
    echo "‚úÖ Configuration reset."
    exit 0
fi

if [[ "$1" == "preset" && "$2" == "--list" ]]; then
    PRESET_PATH="$COFFEE_DIR/presets"
    if [[ ! -d "$PRESET_PATH" ]]; then
        echo "‚ùå No presets found."
        exit 1
    fi

    echo "üé® Available Presets:"
    for d in "$PRESET_PATH"/*; do
        [ -d "$d" ] || continue
        ID="$(basename "$d")"
        INFO="$d/info.txt"

        if [[ -f "$INFO" ]]; then
            # Safely load fields from info.txt
            ICON=""
            NAME=""
            DESCRIPTION=""
            while IFS='=' read -r key value; do
                key="${key//\"/}"
                value="${value//\"/}"
                case "$key" in
                    ICON) ICON="${value}" ;;
                    NAME) NAME="${value}" ;;
                    DESCRIPTION) DESCRIPTION="${value}" ;;
                esac
            done < "$INFO"

            printf "  %s %s (%s) - %s\n" "${ICON:-üìÅ}" "${NAME:-$ID}" "$ID" "${DESCRIPTION:-No description.}"
        else
            printf "  üìÅ %s (%s) - No description.\n" "$ID" "$ID"
        fi
    done
    exit 0
fi


if [[ "$1" == "preset" && "$2" == "--copy" ]]; then
    rm -rf "$COFFEE_DIR/presets"
    mkdir "$COFFEE_DIR/presets"
    cp -r /usr/bitey/software/coffee/presets/* "$COFFEE_DIR/presets"
    exit 0
fi

if [[ "$1" == "preset" ]]; then
    PRESET="$2"
    PRESET_DIR="$COFFEE_DIR/presets/$PRESET"
    if [[ ! -d "$PRESET_DIR" ]]; then # Prevent accedental config deletion and copying non-existent presets.
        echo "‚ùå Preset $PRESET can't be found."
        exit 1
    fi
    rm -rf "$COFFEE_DIR/config"
    mkdir "$COFFEE_DIR/config"
    cp -r $PRESET_DIR/* "$COFFEE_DIR/config"
    echo "‚úÖ Loaded preset $PRESET."
    exit 0
fi
